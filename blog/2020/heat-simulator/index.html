<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>

  Tu Anh-Nguyen


  | Heat Simulation with FreeFEM

</title>
<meta name="description" content="Tu's personal website.
">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="/assets/css/github.css" />

<!-- Styles -->

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü¶Å</text></svg>">

<link rel="stylesheet" href="/assets/css/main.css">
<link rel="canonical" href="/blog/2020/heat-simulator/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->






    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


    <script src="/assets/js/distillpub/template.v2.js"></script>
    <script src="/assets/js/distillpub/transforms.v2.js"></script>
    <script src="/assets/js/distillpub/overrides.js"></script>
    
  </head>

  <d-front-matter>
    <script async type="text/json">{
      "title": "Heat Simulation with FreeFEM",
      "description": "Analyzing a simple heat simulation problem",
      "published": "January 14, 2020",
      "authors": [
        
        {
          "author": "Tu Anh-Nguyen",
          "authorURL": "/",
          "affiliations": [
            {
              "name": "HUST",
              "url": ""
            }
          ]
        }
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script>
  </d-front-matter>

  <body class="fixed-top-nav sticky-bottom-footer">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="https://tu-na.org/">
       Tu Anh-Nguyen
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              about
              
            </a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item active">
            <a class="nav-link" href="/blog/">
              blog
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                publications
                
              </a>
          </li>
          
          
          
          
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="post distill">

      <d-title>
        <h1>Heat Simulation with FreeFEM</h1>
        <p>Analyzing a simple heat simulation problem</p>
      </d-title>

      <d-byline></d-byline>

      <d-article>
        <h2 id="the-problem">The Problem</h2>
<p>This series of blog will focus on how to simulate physical phenomena using finite element method. In the series, I will try not to mention too much about the well-defineness of these problems or the convergence rate of the algorithms. Instead, this blogs aim to give a simple construction and explanation of weak problem for some famous PDE equations.</p>

<p>The first blog in this series start with the heat equation. In the most general form, the heat equation can be written as follow:
\(\begin{align}
\frac{\partial u}{\partial t} - \alpha \Delta &amp;= f(X, t) \tag{1} \\
u(X, 0) &amp;= u_0(X)_{| \Omega} \tag{2} \\
u(X, t) &amp;= u_r(X, t)_{| \Gamma_1} \tag{3} \\
\frac{\partial u}{\partial n} (X, t) &amp;= u_n(X, t)_{| \Gamma_2} \tag{4}
\end{align}\)</p>

<p>Function $u$ represents the heat value for each point in space domain $\Omega$ (2 or 3 dimensions), where $X = [x, y]$ is a point in two-dimensional space (or $X = [x, y, z]$ in three-dimensional space), and $t$ is time variable. Equation (2) is called initial condition, (3) is Dirichlet boundary condition, and (4) is Neumann boundary condition. In this notation, $\Gamma_1$ and $\Gamma_2$ is part of the boundary $\partial \Omega$ satisfying $\Gamma_1 \cup \Gamma_2 = \partial \Omega$. And, $\Delta u$ is the Laplacian operator and is defined as:
\(\Delta u = \frac{\partial^2 u}{\partial x^2} + \frac{\partial^2 u}{\partial y^2}\)
The Laplacian operator at point $X_0 = (x_0, y_0)$ can be interpreted as the average different between the value of $u$ at $X_0$ and the value of its neighbors. In heat diffusion context, we know that heat will move form hotter to colder places, which explain for the left hand side of (1) , where $\alpha$ be diffusivity coefficient (the higher value of $\alpha$, the more resistant to heat of the medium). The right hand side of (1) is the external power (wattage) given to each point in domain $\Omega$ overtime. In case $f = 0$, the heat is allowed to move freely with respect to three constraint (2), (3) and (4). In mathematical context, these condition is required for the uniqueness of $u$. However, each condition has its own physical meaning. Suppose we want to simulate how heat move if we put two $80^o C$conductors in a $20^o C$ room. Initially, every point in the room, except in the conductor, has value of $20^o C$, and we model the initial condition as $u(X, 0) = 20$ on the region not belonging to the conductors‚Äô. If we want to keep the heat of the conductor at a constant $80^o C$, then this mean we do not care about the internal point of them and set $u_r(X, t) =  80^o C$ on boundary of two conductors. Finally Neumann condition represent how much external heat is put through the boundary of $\Omega$,  for example if $u_n(X, t)$ is set to be zero on the boundary of the room, then it means there is no heat coming in or coming out of the room. The 2-D simulation of this phenomenon is conducted in the final section of this blog</p>

<h3 id="how-to-construct-weak-solution-">How to construct weak solution ?</h3>

<p>Numerical solution of heat equations relies on two schemes: discrete time scheme and finite elements method.  The idea is fairly simple, we first divide the time horizon $[0, T]$ into small parts, each parts has the size $\delta t$ ($t_i = i * \delta t$) and approximate $\frac{\partial u}{\partial t} = \frac{u^n(X) - u^{(n - 1)}(X)}{\delta t}$ (here, we denote $u^n(X) =  u(X, t = t_n)$ ), and then try to solve $u^n$ at each time step given we know the previous step $u^{n-1}. To do this, we use finite element methods to solve the following (Backward Euler):</p>

\[\begin{align}
 \frac{u^n(X) - u^{(n - 1)}(X)}{\delta t} - \Delta u^n &amp; = f^n \tag{*} \\
 u^0(X) &amp; = u_0 \\
 u(X, t)_{| \Gamma_1} &amp; = 0 \\
\frac{\partial u}{\partial n} (X, t)_{| \Gamma_2} &amp;= u_n(X, t)
\end{align}\]

<p>The main idea of finite element methods is to partition the domain $\Omega$ into triangles (each triangle is called an element),  each triangle will have a corresponding basis function (commonly linear function). The function $u^n$ will be the linear combination of these basis functions.  When we have the mesh (partition of the domain), and choose a function space to approximate $u$, the only work left is to find the coefficient for each basis functions. Finding these coefficient, in fact, is equivalent to solve system of linear equation. And this equation comes from the construction of weak problem. Let test function $v$ be a function whose value on $\Gamma_1$ equals 0.
\(\begin{align}
\int_{\Omega}\left(\frac{u^n(X) - u^{(n - 1)}(X)}{\delta t}v \right) - \int_\Omega \Delta u^n v &amp; = \int_\Omega f^n v \\
\int_\Omega \frac{u^n v}{\delta t} + \int_\Omega \nabla u^n \nabla v &amp; = \int_\Omega \frac{u^{n-1} v}{\delta t} + \int_\Omega fv + \int_{\partial \Omega} \frac{\partial u^n}{\partial n} v \\
\int_\Omega \frac{u^n v}{\delta t} + \int_\Omega \nabla u^n \nabla v - \int_{\Gamma_2} u_n(X, t_n)v &amp; = \int_\Omega \frac{u^{n-1} v}{\delta t} + \int_\Omega fv \tag{5} \\
\end{align}\)
The equation (5) can be shorten as $a(u, v) = L(v)$ where $a$ is bilinear operator, and $L$ is linear operator. The heat equation new asks for $u$ satisfy (5) with every $v$ in the chosen function space. The problem has unique solutions according to Lax-Milgram Theorem.</p>

<p>And that‚Äôs basically everything we need to use freefem++ to model the heat flow ! I will cover a little more about finite element method in the subsequent blogs. For now, we will turn to simulate the phenomenon described earlier.</p>

<h3 id="numerical-solution">Numerical solution</h3>

<p>The last time I implemented FEM for heat equation by python, and Stokes equations by Matlab was horrible experiences.  The most annoying parts are mesh triangulation and calculating values on stiffness and load matrix to satisfy all boundary conditions. However, I found everything is so simple with Freefem. Basically, there‚Äôs only two step, ‚Äò‚Äô draw ‚Äú the domain and rewrite the weak problem. The following code is the simulation of physical phenomena described in the introduction. There‚Äôs a minor change is that I put a wall divided the room into two half, and this wall have diffusivity constant 3 times greater than that of air.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">border</span> <span class="nf">C1</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">){</span><span class="n">x</span><span class="o">=-</span><span class="mi">5</span><span class="o">+</span><span class="n">t</span><span class="p">;</span><span class="n">y</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span><span class="n">label</span><span class="o">=</span><span class="mi">100</span><span class="p">;}</span>
<span class="n">border</span> <span class="nf">C2</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">){</span><span class="n">x</span><span class="o">=-</span><span class="mi">4</span><span class="p">;</span><span class="n">y</span><span class="o">=</span><span class="mi">4</span><span class="o">-</span><span class="n">t</span><span class="p">;</span><span class="n">label</span><span class="o">=</span><span class="mi">100</span><span class="p">;}</span>
<span class="n">border</span> <span class="nf">C3</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">){</span><span class="n">x</span><span class="o">=-</span><span class="mi">4</span><span class="o">-</span><span class="n">t</span><span class="p">;</span><span class="n">y</span><span class="o">=-</span><span class="mi">4</span><span class="p">;</span><span class="n">label</span><span class="o">=</span><span class="mi">100</span><span class="p">;}</span>
<span class="n">border</span> <span class="nf">C4</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">){</span><span class="n">x</span><span class="o">=-</span><span class="mi">5</span><span class="p">;</span><span class="n">y</span><span class="o">=-</span><span class="mi">4</span><span class="o">+</span><span class="n">t</span><span class="p">;</span><span class="n">label</span><span class="o">=</span><span class="mi">100</span><span class="p">;}</span>

<span class="n">border</span> <span class="nf">C5</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">){</span><span class="n">x</span><span class="o">=</span><span class="mi">5</span><span class="o">+</span><span class="n">t</span><span class="p">;</span><span class="n">y</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span><span class="n">label</span><span class="o">=</span><span class="mi">101</span><span class="p">;}</span>
<span class="n">border</span> <span class="nf">C6</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">){</span><span class="n">x</span><span class="o">=</span><span class="mi">6</span><span class="p">;</span><span class="n">y</span><span class="o">=</span><span class="mi">4</span><span class="o">-</span><span class="n">t</span><span class="p">;</span><span class="n">label</span><span class="o">=</span><span class="mi">101</span><span class="p">;}</span>
<span class="n">border</span> <span class="nf">C7</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">){</span><span class="n">x</span><span class="o">=</span><span class="mi">6</span><span class="o">-</span><span class="n">t</span><span class="p">;</span><span class="n">y</span><span class="o">=-</span><span class="mi">4</span><span class="p">;</span><span class="n">label</span><span class="o">=</span><span class="mi">101</span><span class="p">;}</span>
<span class="n">border</span> <span class="nf">C8</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">){</span><span class="n">x</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span><span class="n">y</span><span class="o">=-</span><span class="mi">4</span><span class="o">+</span><span class="n">t</span><span class="p">;</span><span class="n">label</span><span class="o">=</span><span class="mi">101</span><span class="p">;}</span>

<span class="n">border</span> <span class="nf">C9</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">){</span><span class="n">x</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="p">);</span><span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="p">);</span><span class="n">label</span><span class="o">=</span><span class="mi">102</span><span class="p">;}</span>
<span class="n">real</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="n">mesh</span> <span class="n">Th</span> <span class="o">=</span> <span class="n">buildmesh</span><span class="p">(</span><span class="n">C1</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C2</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C3</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C4</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C5</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> 
<span class="n">C6</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C7</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C8</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">C9</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
<span class="n">fespace</span> <span class="nf">Vh</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span><span class="n">P1</span><span class="p">);</span>
<span class="n">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">);</span>

<span class="n">func</span> <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">&lt;=</span><span class="mf">0.25</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="o">&gt;=-</span><span class="mf">0.25</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">Vh</span> <span class="n">kappa</span> <span class="o">=</span> <span class="n">k</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">u0</span><span class="p">;</span>

<span class="n">u0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">real</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">;</span>
<span class="n">real</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">t</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">T</span><span class="o">/</span><span class="n">dt</span><span class="p">;</span> <span class="n">t</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">solve</span> <span class="n">heat</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="n">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">u</span><span class="o">*</span><span class="n">v</span> <span class="o">+</span> <span class="n">dx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">kappa</span> <span class="o">+</span> <span class="n">dy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">dy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">kappa</span><span class="p">)</span>

	<span class="o">-</span> <span class="n">int2d</span><span class="p">(</span><span class="n">Th</span><span class="p">)(</span><span class="n">u0</span><span class="o">*</span><span class="n">v</span><span class="p">)</span>
	<span class="o">+</span> <span class="n">on</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">u</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> <span class="o">+</span> <span class="n">on</span><span class="p">(</span><span class="mi">101</span><span class="p">,</span><span class="n">u</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span> <span class="o">+</span> <span class="n">on</span><span class="p">(</span><span class="mi">102</span><span class="p">,</span><span class="n">u</span><span class="o">=</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">u0</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">++</span><span class="p">;</span>
	<span class="n">plot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ps</span><span class="o">=</span><span class="s">"./heat simulation/sol_"</span><span class="o">+</span><span class="n">count</span><span class="o">+</span><span class="s">".jpg"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="row mt-3">                                                           
    <div class="col-sm mt-3 mt-md-0">                                            
        <img class="img-fluid rounded z-depth-0" src="/assets/img/heat-simulation.gif" />
    </div>                                                                       
</div>
<div class="caption">                                                            
    Heat Simulation
</div>


      </d-article>

      <d-appendix>
        <d-footnote-list></d-footnote-list>
        <d-citation-list></d-citation-list>
      </d-appendix>

    </div>

    <!-- Footer -->

    
<footer class="sticky-bottom mt-5">
  <div class="container">
    &copy; Copyright 2023 Tu Anh Nguyen.
    
    
    
    Last updated: April 29, 2023.
    
  </div>
</footer>



  </body>

  <d-bibliography src="/assets/bibliography/">
  </d-bibliography>

</html>
